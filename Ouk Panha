local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local RunService = game:GetService("RunService")
local RemoteEvent = ReplicatedStorage.Modules.Network.RemoteEvent
local UIS = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local device = "Mobile"

local function getBehaviorFolder()
    return ReplicatedStorage:WaitForChild("Assets")
        :WaitForChild("Survivors")
        :WaitForChild("Veeronica")
        :WaitForChild("Behavior")
end

local function getSprintingButton()
    return player.PlayerGui:WaitForChild("MainUI"):WaitForChild("SprintingButton")
end

local behaviorFolder = getBehaviorFolder()

-- safe helper
local function safeConnectPropertyChanged(instance, prop, fn)
    local ok, signal = pcall(function() return instance:GetPropertyChangedSignal(prop) end)
    if ok and signal then
        return signal:Connect(fn)
    end
    return nil
end

-- Manager state
local enabled = true
local activeMonitors = {} -- highlight -> cleanup function
local descendantAddedConn = nil

-- Monitor a single Highlight. Returns cleanup function (also stored into activeMonitors)
local function monitorHighlight(h)
    if not h or activeMonitors[h] then return end

    local connections = {}
    local prevState = false

    local function cleanup()
        for _, conn in ipairs(connections) do
            if conn and conn.Connected then
                conn:Disconnect()
            end
        end
        activeMonitors[h] = nil
    end

    local function adorneeIsPlayerCharacter(h)
        if not h then return false end
        local adornee = h.Adornee
        local char = player.Character
        if not adornee or not char then return false end
        if adornee == char then return true end
        if adornee:IsDescendantOf(char) then return true end
        return false
    end

    local function onChanged()
        -- if disabled, skip doing actions (cleanup will be called by stopManager)
        if not enabled then return end
        if not h or not h.Parent then
            cleanup()
            return
        end

        local currState = adorneeIsPlayerCharacter(h)
        if prevState ~= currState then
            if currState then
                if device == "Mobile" then
                    local ok, btn = pcall(getSprintingButton)
                    if ok and btn then
                        -- try to call any MouseButton1Down connections (original behavior)
                        for i, v in pairs(getconnections(btn.MouseButton1Down)) do
                            pcall(function() v:Fire() end)
                            -- original had v:Function(), keep safe
                            pcall(function() if v.Function then v:Function() end end)
                        end
                    end
                end
            end
        end
        prevState = currState
    end

    local c = safeConnectPropertyChanged(h, "Adornee", onChanged)
    if c then table.insert(connections, c) end

    table.insert(connections, h.AncestryChanged:Connect(function(_, parent)
        if not parent then
            cleanup()
        else
            onChanged()
        end
    end))

    table.insert(connections, player.CharacterAdded:Connect(onChanged))
    table.insert(connections, player.CharacterRemoving:Connect(onChanged))

    -- store cleanup so manager can stop monitors later
    activeMonitors[h] = cleanup

    -- initial check
    task.spawn(onChanged)
end

-- Start watching all highlights and listen for new ones
local function startManager()
    if descendantAddedConn then return end
    -- watch existing
    for _, desc in ipairs(behaviorFolder:GetDescendants()) do
        if desc:IsA("Highlight") then
            monitorHighlight(desc)
        end
    end
    -- listen for new highlights
    descendantAddedConn = behaviorFolder.DescendantAdded:Connect(function(child)
        if child:IsA("Highlight") then
            monitorHighlight(child)
        end
    end)
end

-- Stop watching and cleanup everything
local function stopManager()
    if descendantAddedConn and descendantAddedConn.Connected then
        descendantAddedConn:Disconnect()
    end
    descendantAddedConn = nil

    -- copy keys to avoid mutation during iteration
    local cleans = {}
    for h, cleanup in pairs(activeMonitors) do
        if type(cleanup) == "function" then
            table.insert(cleans, cleanup)
        end
    end
    for _, fn in ipairs(cleans) do
        pcall(fn)
    end
    activeMonitors = {}
end

-- Toggle
local function setEnabled(v)
    if enabled == v then return end
    enabled = v
    if enabled then
        startManager()
    else
        stopManager()
    end
end

-- Create a modern toggle GUI in PlayerGui
local function createToggleGui()
    local pg = player:WaitForChild("PlayerGui")
    -- avoid creating multiple copies
    if pg:FindFirstChild("AutoSprintToggleGui") then
        return pg.AutoSprintToggleGui
    end

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "AutoSprintToggleGui"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = pg

    -- Main container frame
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 200, 0, 80)
    mainFrame.Position = UDim2.new(0, 20, 0, 20)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    mainFrame.BorderSizePixel = 0
    mainFrame.BackgroundTransparency = 0.1
    mainFrame.Parent = screenGui
    
    -- Add rounded corners
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = mainFrame
    
    -- Add subtle shadow/depth
    local shadow = Instance.new("UIStroke")
    shadow.Color = Color3.fromRGB(0, 0, 0)
    shadow.Thickness = 2
    shadow.Transparency = 0.7
    shadow.Parent = mainFrame

    -- Title label
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "TitleLabel"
    titleLabel.Size = UDim2.new(1, 0, 0, 30)
    titleLabel.Position = UDim2.new(0, 0, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = "AUTO TRICK"
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 16
    titleLabel.TextXAlignment = Enum.TextXAlignment.Center
    titleLabel.Parent = mainFrame

    -- Toggle button container
    local toggleContainer = Instance.new("Frame")
    toggleContainer.Name = "ToggleContainer"
    toggleContainer.Size = UDim2.new(0.8, 0, 0, 40)
    toggleContainer.Position = UDim2.new(0.1, 0, 0, 35)
    toggleContainer.BackgroundTransparency = 1
    toggleContainer.Parent = mainFrame

    -- Toggle background
    local toggleBackground = Instance.new("Frame")
    toggleBackground.Name = "ToggleBackground"
    toggleBackground.Size = UDim2.new(0, 60, 0, 30)
    toggleBackground.Position = UDim2.new(0.5, -30, 0, 5)
    toggleBackground.BackgroundColor3 = enabled and Color3.fromRGB(86, 171, 88) or Color3.fromRGB(171, 86, 86)
    toggleBackground.BorderSizePixel = 0
    toggleBackground.Parent = toggleContainer
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 15)
    toggleCorner.Parent = toggleBackground

    -- Toggle knob
    local toggleKnob = Instance.new("Frame")
    toggleKnob.Name = "ToggleKnob"
    toggleKnob.Size = UDim2.new(0, 20, 0, 20)
    toggleKnob.Position = enabled and UDim2.new(1, -25, 0, 5) or UDim2.new(0, 5, 0, 5)
    toggleKnob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    toggleKnob.BorderSizePixel = 0
    toggleKnob.Parent = toggleBackground
    
    local knobCorner = Instance.new("UICorner")
    knobCorner.CornerRadius = UDim.new(0, 10)
    knobCorner.Parent = toggleKnob

    -- Status label
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Name = "StatusLabel"
    statusLabel.Size = UDim2.new(1, 0, 0, 20)
    statusLabel.Position = UDim2.new(0, 0, 1, 5)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = enabled and "ENABLED" or "DISABLED"
    statusLabel.TextColor3 = enabled and Color3.fromRGB(86, 171, 88) or Color3.fromRGB(171, 86, 86)
    statusLabel.Font = Enum.Font.GothamMedium
    statusLabel.TextSize = 12
    statusLabel.TextXAlignment = Enum.TextXAlignment.Center
    statusLabel.Parent = toggleContainer

    -- Clickable area (transparent button over the whole toggle)
    local toggleButton = Instance.new("TextButton")
    toggleButton.Name = "ToggleButton"
    toggleButton.Size = UDim2.new(1, 0, 1, 0)
    toggleButton.Position = UDim2.new(0, 0, 0, 0)
    toggleButton.BackgroundTransparency = 1
    toggleButton.Text = ""
    toggleButton.Parent = toggleContainer

    -- Toggle animation function
    local function animateToggle(newState)
        local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
        
        local backgroundTween = TweenService:Create(
            toggleBackground,
            tweenInfo,
            {BackgroundColor3 = newState and Color3.fromRGB(86, 171, 88) or Color3.fromRGB(171, 86, 86)}
        )
        
        local knobTween = TweenService:Create(
            toggleKnob,
            tweenInfo,
            {Position = newState and UDim2.new(1, -25, 0, 5) or UDim2.new(0, 5, 0, 5)}
        )
        
        statusLabel.Text = newState and "ENABLED" or "DISABLED"
        statusLabel.TextColor3 = newState and Color3.fromRGB(86, 171, 88) or Color3.fromRGB(171, 86, 86)
        
        backgroundTween:Play()
        knobTween:Play()
    end

    -- click toggles with animation
    toggleButton.MouseButton1Click:Connect(function()
        setEnabled(not enabled)
        animateToggle(enabled)
    end)

    -- Make the UI draggable
    local dragging = false
    local dragInput, dragStart, startPos

    local function update(input)
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    titleLabel.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    titleLabel.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    UIS.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)

    return screenGui
end

-- initialize
createToggleGui()
if enabled then
    startManager()
end

-- ensure toggle GUI persists across character respawn
player.CharacterAdded:Connect(function()
    -- small delay to ensure PlayerGui elements (like MainUI) are available
    task.wait(0.2)
    createToggleGui()
end)
